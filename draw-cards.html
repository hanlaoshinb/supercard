<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抽取塔罗牌 - 塔罗牌在线占卜</title>
    <meta name="description" content="抽取您的塔罗牌，获得专业塔罗牌占卜解读，了解您的爱情、事业和人生走向。">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7D56F4', // 主色调，紫色
                        secondary: '#FFC107', // 辅助色，金色
                        dark: '#1D1D1F', // 深色背景
                        light: '#F5F5F7', // 浅色背景
                    },
                    fontFamily: {
                        sans: ['SF Pro Display', 'SF Pro Text', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-gradient {
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            
            .tarot-card {
                transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                transform-style: preserve-3d;
                perspective: 1000px;
            }
            
            .tarot-card.flipped {
                transform: rotateY(180deg);
            }
            
            .tarot-card-front,
            .tarot-card-back {
                backface-visibility: hidden;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
            
            .tarot-card-front {
                transform: rotateY(180deg);
            }
            
            .tarot-card-back {
                transform: rotateY(0deg);
            }
            
            .card-1 {
                transform: translateX(-40%) rotate(-8deg);
            }
            
            .card-2 {
                transform: translateX(0);
                z-index: 10;
            }
            
            .card-3 {
                transform: translateX(40%) rotate(8deg);
            }
            
            @keyframes float {
                0% {
                    transform: translateY(0px);
                }
                50% {
                    transform: translateY(-10px);
                }
                100% {
                    transform: translateY(0px);
                }
            }
            
            .floating {
                animation: float 3s ease-in-out infinite;
            }

            .card-wrapper {
                position: relative;
                overflow: hidden;
            }
            
            .mystic-bg {
                background: linear-gradient(135deg, #1a1a2e, #16213e, #1a1a2e);
            }
            
            .card-slot {
                border: 2px dashed rgba(215, 170, 100, 0.3);
                border-radius: 0.75rem;
                display: flex;
                align-items: center;
                justify-content: center;
                color: rgba(215, 170, 100, 0.5);
                background: rgba(0, 0, 0, 0.2);
                transition: all 0.3s ease;
                position: relative;
            }
            
            .card-slot.highlight {
                border-color: rgba(215, 170, 100, 0.8);
                box-shadow: 0 0 15px rgba(215, 170, 100, 0.4);
            }
            
            .card-slot.filled {
                border-style: solid;
                border-color: rgba(215, 170, 100, 0.5);
                background: rgba(0, 0, 0, 0.3);
            }
            
            .card-slot.filled span {
                opacity: 0;
            }

            .canvas-container {
                position: relative;
                width: 100%;
                height: 300px;
                overflow: hidden;
            }
            
            #tarotCanvas {
                cursor: pointer;
                display: block;
                margin: 0 auto;
                background: transparent;
            }
            
            .card-info-panel {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 300px;
                background: rgba(26, 26, 46, 0.95);
                border: 1px solid rgba(215, 170, 100, 0.5);
                border-radius: 15px;
                padding: 20px;
                z-index: 100;
                box-shadow: 0 0 30px rgba(0, 0, 0, 0.6), 0 0 15px rgba(215, 170, 100, 0.4);
                display: none;
                backdrop-filter: blur(10px);
            }
            
            .card-info-panel img {
                width: 120px;
                margin: 0 auto 15px;
                display: block;
                border-radius: 5px;
                border: 1px solid rgba(215, 170, 100, 0.5);
            }
            
            .card-info-panel h3 {
                color: rgb(215, 170, 100);
                font-size: 1.25rem;
                text-align: center;
                margin-bottom: 10px;
                font-weight: 600;
            }
            
            .card-info-panel p {
                color: rgba(255, 255, 255, 0.8);
                font-size: 0.9rem;
                line-height: 1.5;
                margin-bottom: 15px;
            }
            
            .card-info-panel button {
                background: linear-gradient(45deg, #7D56F4, #9678FF);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 0.9rem;
                cursor: pointer;
                width: 100%;
                transition: all 0.3s ease;
            }
            
            .card-info-panel button:hover {
                background: linear-gradient(45deg, #6A46E5, #8A6BFF);
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            }
            
            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(3px);
                z-index: 90;
                display: none;
            }
        }
    </style>
</head>
<body class="font-sans text-dark bg-light min-h-screen flex flex-col">
    <!-- 移动设备导航菜单 -->
    <div id="mobile-menu" class="fixed inset-0 bg-dark/95 z-50 flex items-center justify-center transform transition-transform duration-300 translate-x-full">
        <button id="close-menu" class="absolute top-5 right-5 text-white focus:outline-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <nav class="flex flex-col items-center space-y-6">
            <a href="#" class="text-xl font-medium text-white hover:text-primary transition-colors">
                <span class="mr-1">👑</span> 会员订阅
            </a>
            <a href="#" class="text-xl font-medium text-white hover:text-primary transition-colors">
                AI塔罗占卜
            </a>
            <a href="#" class="text-xl font-medium text-white hover:text-primary transition-colors">
                故事分享
            </a>
            <a href="#" class="text-xl font-medium text-white hover:text-primary transition-colors">
                问题反馈
            </a>
        </nav>
    </div>

    <!-- 导航栏 -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-200">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <a href="/" class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                </svg>
                <span class="text-xl font-bold">Tarotap</span>
            </a>
            
            <nav class="hidden md:flex items-center space-x-6">
                <a href="#" class="flex items-center px-2 py-1 rounded-md font-medium text-gray-700 hover:text-primary transition-colors">
                    <span class="mr-1">👑</span> 会员订阅
                </a>
                <a href="#" class="flex items-center px-2 py-1 rounded-md font-medium text-gray-700 hover:text-primary transition-colors">
                    AI塔罗占卜
                </a>
                <a href="#" class="flex items-center px-2 py-1 rounded-md font-medium text-gray-700 hover:text-primary transition-colors">
                    故事分享
                </a>
                <a href="#" class="flex items-center px-2 py-1 rounded-md font-medium text-gray-700 hover:text-primary transition-colors">
                    问题反馈
                </a>
            </nav>
            
            <div class="flex items-center space-x-4">
                <button id="mobile-menu-btn" class="md:hidden text-dark focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <div class="hidden md:block h-8 w-8 rounded-full bg-gradient-to-r from-primary to-purple-300 flex items-center justify-center text-white">
                    <span class="text-sm font-medium">M</span>
                </div>
            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="flex-grow">
        <!-- 抽牌区域 -->
        <section class="py-6 md:py-8 text-center">
            <div class="container mx-auto px-4 max-w-4xl">
                <h1 class="text-3xl md:text-4xl font-bold mb-3 flex flex-col items-center justify-center">
                    <span class="text-gradient bg-gradient-to-r from-purple-500 to-primary block">时间流牌阵</span>
                </h1>
                
                <p class="text-gray-600 text-sm md:text-base max-w-2xl mx-auto mb-6">在牌列中选择并点击三张塔罗牌，揭示过去、现在和未来的讯息。</p>
                
                <!-- 用户问题显示 -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-8">
                    <h3 class="text-gray-500 text-sm mb-1">您的问题</h3>
                    <p id="user-question" class="text-gray-800 font-medium">加载中...</p>
                </div>
                
                <!-- 已选择卡牌数量指示器 -->
                <div class="mb-4 text-center">
                    <span class="text-white bg-primary/90 px-4 py-1.5 rounded-full font-medium" id="cards-counter">已选择: 0/3</span>
                </div>
                
                <!-- Canvas 抽牌区域 -->
                <div class="card-wrapper mystic-bg rounded-xl overflow-hidden shadow-lg">
                    <div class="canvas-container">
                        <canvas id="tarotCanvas"></canvas>
                    </div>
                    
                    <!-- 卡牌槽位 -->
                    <div class="flex flex-col md:flex-row justify-center gap-4 md:gap-8 p-6">
                        <div class="card-slot relative h-44 w-28 md:h-52 md:w-32 flex items-center justify-center" data-position="过去">
                            <span class="opacity-50">过去</span>
                        </div>
                        <div class="card-slot relative h-44 w-28 md:h-52 md:w-32 flex items-center justify-center" data-position="现在">
                            <span class="opacity-50">现在</span>
                        </div>
                        <div class="card-slot relative h-44 w-28 md:h-52 md:w-32 flex items-center justify-center" data-position="未来">
                            <span class="opacity-50">未来</span>
                        </div>
                    </div>
                </div>
                
                <!-- 指引文字 -->
                <p id="draw-instruction" class="text-primary font-medium my-6">请在牌列中选择三张塔罗牌</p>
                
                <!-- 查看结果按钮 (初始隐藏) -->
                <div id="view-result-btn" class="hidden">
                    <a href="#" class="inline-block bg-gradient-to-r from-primary to-purple-800 text-white font-medium py-3 px-8 rounded-lg shadow-lg hover:shadow-xl hover:translate-y-[-2px] transition-all duration-200 relative overflow-hidden group">
                        <span class="relative z-10">查看占卜结果</span>
                        <span class="absolute inset-0 bg-gradient-to-r from-primary/80 to-purple-700/80 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></span>
                    </a>
                </div>
            </div>
        </section>
    </main>
    
    <!-- 卡牌信息面板 -->
    <div class="card-info-panel" id="cardInfoPanel">
        <img src="" alt="塔罗牌" id="cardImage">
        <h3 id="cardName">塔罗牌名称</h3>
        <p id="cardDescription">塔罗牌描述内容...</p>
        <button id="placeCardBtn">放置卡牌</button>
    </div>
    
    <!-- 背景遮罩 -->
    <div class="overlay" id="overlay"></div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-lg font-semibold mb-4">关于我们</h3>
                    <p class="text-gray-400 text-sm">Tarotap是一个专业的在线塔罗牌占卜平台，致力于通过现代科技与古老智慧的结合，为用户提供准确、便捷的塔罗牌解读服务。</p>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">快速链接</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors">首页</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors">塔罗牌占卜</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors">会员服务</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors">学习中心</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">联系我们</h3>
                    <ul class="space-y-2 text-sm">
                        <li class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            <span class="text-gray-400">contact@aihinto.com</span>
                        </li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">关注我们</h3>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400 text-sm">
                <p>&copy; 2025 Tarotap. 版权所有 Michael</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript 代码 -->
    <script>
        // 移动设备菜单控制
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeMenuBtn = document.getElementById('close-menu');

        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.remove('translate-x-full');
            mobileMenu.classList.add('translate-x-0');
        });

        closeMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.remove('translate-x-0');
            mobileMenu.classList.add('translate-x-full');
        });
        
        // 从URL获取查询参数
        const urlParams = new URLSearchParams(window.location.search);
        const master = urlParams.get('master');
        const question = urlParams.get('question');
        const spread = urlParams.get('spread');
        
        // 显示用户问题
        const userQuestionEl = document.getElementById('user-question');
        if (question) {
            userQuestionEl.textContent = decodeURIComponent(question);
        } else {
            userQuestionEl.textContent = "没有提供问题";
        }
        
        // 更新标题显示选择的牌阵
        const titleEl = document.querySelector('h1 span');
        if (spread) {
            const spreadName = decodeURIComponent(spread).replace(/-/g, ' ');
            const capitalizedSpread = spreadName.split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
            titleEl.textContent = capitalizedSpread + '牌阵';
        }
        
        // Canvas 相关变量
        const canvas = document.getElementById('tarotCanvas');
        const ctx = canvas.getContext('2d');
        const cardsCounter = document.getElementById('cards-counter');
        const drawInstruction = document.getElementById('draw-instruction');
        const viewResultBtn = document.getElementById('view-result-btn');
        const cardSlots = document.querySelectorAll('.card-slot');
        const cardInfoPanel = document.getElementById('cardInfoPanel');
        const overlay = document.getElementById('overlay');
        const cardImage = document.getElementById('cardImage');
        const cardName = document.getElementById('cardName');
        const cardDescription = document.getElementById('cardDescription');
        const placeCardBtn = document.getElementById('placeCardBtn');
        
        // 塔罗牌数据
        const tarotCardNames = [
            {name: "愚者", description: "代表新的开始和无限可能，象征着自由、冒险和潜力。意味着需要开放心态面对未知事物。"},
            {name: "魔术师", description: "象征创造力和主动性，代表将想法转化为行动的能力。提示你有能力掌控局面，实现目标。"},
            {name: "女祭司", description: "象征直觉和潜意识，提示你倾听内心的声音，相信自己的感觉。建议保持耐心，等待更多信息显现。"},
            {name: "女皇", description: "代表丰盛、滋养和创造，象征着爱、和谐与安全感。提示你关注物质与精神的平衡。"},
            {name: "皇帝", description: "象征权威和控制，代表结构、稳定和秩序。提示你需要更有条理地处理事务，建立明确的界限。"},
            {name: "教皇", description: "代表传统和精神指引，象征遵循既定规则与道德标准。提示你寻求智慧指导或尊重传统价值观。"},
            {name: "恋人", description: "象征关系和选择，代表爱情、和谐与价值观的统一。提示你面临重要选择，需要全面考虑。"},
            {name: "战车", description: "象征决心和胜利，代表通过自控和专注实现目标。提示你坚持不懈，克服挑战，保持前进。"},
            {name: "力量", description: "代表内在力量和勇气，象征通过耐心和自信克服困难。提示你用温和而坚定的方式解决问题。"},
            {name: "隐者", description: "象征内省和寻找内在智慧，代表独处和反思的价值。提示你需要时间沉思，寻找内心的答案。"},
            {name: "命运之轮", description: "代表命运变化和生命周期，象征着转变和机会。提示你接受变化，理解生活的循环本质。"},
            {name: "正义", description: "象征平衡和诚实，代表公平、真理和法律。提示你要客观审视情况，寻求平衡的解决方案。"},
            {name: "悬吊者", description: "代表牺牲和新视角，象征放手和接受。提示你需要改变视角或暂停行动，获得新的理解。"},
            {name: "死神", description: "象征转变和结束，代表一个阶段的完结和新阶段的开始。提示你需要放下过去，迎接转变。"},
            {name: "节制", description: "代表平衡和适度，象征和谐融合与自我控制。提示你需要耐心、适度和平衡的方法。"},
            {name: "恶魔", description: "象征束缚和物质执着，代表欲望和依附。提示你需要认识到自己的限制和不健康的模式。"},
            {name: "塔", description: "代表突然变化和启示，象征颠覆和解放。提示你可能面临意外的转变，需要接受新的现实。"},
            {name: "星星", description: "象征希望和灵感，代表内心平静和精神更新。提示你要保持信心，相信未来会更美好。"},
            {name: "月亮", description: "代表直觉和潜意识，象征恐惧和迷惑。提示你需要面对内心深处的情感和不安。"},
            {name: "太阳", description: "象征成功和活力，代表喜悦和清晰。提示你即将进入一个充满正能量和成功的时期。"},
            {name: "审判", description: "代表觉醒和更新，象征重生和转变。提示你需要诚实面对自己，接受真正的自我。"},
            {name: "世界", description: "象征完成和整合，代表成就和圆满。提示你已经达到了一个重要的里程碑，完成了一个周期。"}
        ];
        
        // 塔罗牌卡牌类
        class TarotCard {
            constructor(id, name, description) {
                this.id = id;
                this.name = name;
                this.description = description;
                this.x = 0;
                this.y = 0;
                this.width = 70;
                this.height = 112;
                this.selected = false;
                this.highlighted = false;
                this.placed = false;
                this.position = null; // 过去、现在、未来
                this.angle = 0; // 旋转角度
                this.currentScale = 1; // 当前缩放
                this.targetPosition = { x: 0, y: 0 }; // 动画目标位置
                this.animating = false;
                this.slotElement = null; // 关联的槽位DOM元素
            }
            
            draw(ctx) {
                ctx.save();
                
                // 移动到卡牌中心点
                ctx.translate(this.x + this.width / 2, this.y + this.height / 2);
                
                // 应用旋转
                ctx.rotate(this.angle * Math.PI / 180);
                
                // 应用缩放
                ctx.scale(this.currentScale, this.currentScale);
                
                // 绘制卡牌背景
                ctx.shadowColor = this.highlighted ? 'rgba(215, 170, 100, 0.7)' : 'rgba(0, 0, 0, 0.3)';
                ctx.shadowBlur = this.highlighted ? 15 : 5;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 2;
                
                // 卡牌背面
                const gradient = ctx.createLinearGradient(-this.width/2, -this.height/2, this.width/2, this.height/2);
                gradient.addColorStop(0, '#422e83');
                gradient.addColorStop(1, '#7D56F4');
                
                ctx.fillStyle = gradient;
                ctx.roundRect(-this.width/2, -this.height/2, this.width, this.height, 5);
                ctx.fill();
                
                // 卡牌边框
                ctx.lineWidth = 1;
                ctx.strokeStyle = this.highlighted ? 'rgba(215, 170, 100, 0.8)' : 'rgba(215, 170, 100, 0.3)';
                ctx.roundRect(-this.width/2, -this.height/2, this.width, this.height, 5);
                ctx.stroke();
                
                // 卡牌花纹
                ctx.lineWidth = 0.5;
                ctx.strokeStyle = 'rgba(215, 170, 100, 0.2)';
                ctx.roundRect(-this.width/2 + 3, -this.height/2 + 3, this.width - 6, this.height - 6, 3);
                ctx.stroke();
                
                // 卡牌星星图案
                ctx.fillStyle = 'rgba(215, 170, 100, 0.3)';
                this.drawStar(ctx, 0, 0, 5, 10, 5);
                
                ctx.restore();
            }
            
            drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius) {
                let rot = Math.PI / 2 * 3;
                let x = cx;
                let y = cy;
                let step = Math.PI / spikes;
                
                ctx.beginPath();
                ctx.moveTo(cx, cy - outerRadius);
                
                for (let i = 0; i < spikes; i++) {
                    x = cx + Math.cos(rot) * outerRadius;
                    y = cy + Math.sin(rot) * outerRadius;
                    ctx.lineTo(x, y);
                    rot += step;
                    
                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    ctx.lineTo(x, y);
                    rot += step;
                }
                
                ctx.lineTo(cx, cy - outerRadius);
                ctx.closePath();
                ctx.fill();
            }
            
            isMouseOver(mouseX, mouseY) {
                return mouseX >= this.x && mouseX <= this.x + this.width &&
                       mouseY >= this.y && mouseY <= this.y + this.height;
            }
        }
        
        // 主应用类
        class TarotApp {
            constructor() {
                this.cards = [];
                this.selectedCards = [];
                this.currentCard = null;
                this.mouseX = 0;
                this.mouseY = 0;
                this.canvasWidth = 0;
                this.canvasHeight = 0;
                this.cardWidth = 70;
                this.cardHeight = 112;
                this.cardGap = 10;
                this.isDragging = false;
                this.isAnimating = false;
                this.currentSlot = null;
                
                this.init();
            }
            
            init() {
                // 调整Canvas大小
                this.resizeCanvas();
                
                // 创建塔罗牌
                this.createCards();
                
                // 设置事件监听
                this.setupEventListeners();
                
                // 开始动画循环
                this.animate();
            }
            
            resizeCanvas() {
                const container = canvas.parentElement;
                this.canvasWidth = container.clientWidth;
                this.canvasHeight = container.clientHeight;
                
                canvas.width = this.canvasWidth;
                canvas.height = this.canvasHeight;
                
                // 调整卡牌尺寸
                this.cardWidth = 70;  // 增大卡牌尺寸
                this.cardHeight = 112;
                
                // 重新排列卡牌，如果已存在
                if (this.cards.length > 0) {
                    this.arrangeCards();
                }
            }
            
            createCards() {
                // 清空现有卡牌
                this.cards = [];
                
                // 随机选择20张塔罗牌
                const shuffledCards = [...tarotCardNames].sort(() => Math.random() - 0.5).slice(0, 22);
                
                // 创建卡牌对象
                shuffledCards.forEach((card, index) => {
                    this.cards.push(new TarotCard(index, card.name, card.description));
                });
                
                // 排列卡牌
                this.arrangeCards();
            }
            
            arrangeCards() {
                // 把卡牌放在画布中更靠下的位置，更靠近槽位
                const deckWidth = (this.cards.length - 1) * (this.cardWidth * 0.3) + this.cardWidth;
                let startX = (this.canvasWidth - deckWidth) / 2;
                
                this.cards.forEach((card, index) => {
                    card.width = this.cardWidth;
                    card.height = this.cardHeight;
                    card.x = startX + index * (this.cardWidth * 0.3);
                    card.y = 150; // 调整垂直位置，使其更靠近底部的槽位
                    card.angle = 0;
                    card.currentScale = 1;
                });
            }
            
            setupEventListeners() {
                // 鼠标移动
                canvas.addEventListener('mousemove', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    this.mouseX = e.clientX - rect.left;
                    this.mouseY = e.clientY - rect.top;
                    
                    // 检查卡牌悬停
                    let hoveredCard = null;
                    
                    if (!this.isAnimating) {
                        // 逆序检查，这样最上面的卡牌会先检测到
                        for (let i = this.cards.length - 1; i >= 0; i--) {
                            const card = this.cards[i];
                            if (!card.placed && card.isMouseOver(this.mouseX, this.mouseY)) {
                                hoveredCard = card;
                                break;
                            }
                        }
                    }
                    
                    // 更新卡牌高亮状态
                    this.cards.forEach(card => {
                        card.highlighted = card === hoveredCard;
                        
                        // 如果卡牌被高亮，稍微缩放它
                        if (card.highlighted && !card.animating) {
                            card.currentScale = 1.1;
                            card.y = 40; // 稍微向上移动
                        } else if (!card.animating && !card.placed) {
                            card.currentScale = 1;
                            card.y = 50;
                        }
                    });
                });
                
                // 鼠标点击
                canvas.addEventListener('click', (e) => {
                    if (this.isAnimating) return;
                    
                    // 找到点击的卡牌
                    let clickedCard = null;
                    
                    // 逆序检查，这样最上面的卡牌会先检测到
                    for (let i = this.cards.length - 1; i >= 0; i--) {
                        const card = this.cards[i];
                        if (!card.placed && card.isMouseOver(this.mouseX, this.mouseY)) {
                            clickedCard = card;
                            break;
                        }
                    }
                    
                    if (clickedCard && this.selectedCards.length < 3) {
                        this.currentCard = clickedCard;
                        this.animateCardSelection(clickedCard);
                    }
                });
                
                // 监听窗口大小变化
                window.addEventListener('resize', () => {
                    this.resizeCanvas();
                });
                
                // 放置卡牌按钮点击事件
                placeCardBtn.addEventListener('click', () => {
                    // 隐藏信息面板
                    cardInfoPanel.style.display = 'none';
                    overlay.style.display = 'none';
                    
                    if (this.currentCard && this.currentSlot) {
                        this.placeCardInSlot(this.currentCard, this.currentSlot);
                    }
                });
            }
            
            // 动画：选中卡牌
            animateCardSelection(card) {
                this.isAnimating = true;
                card.animating = true;
                
                // 计算卡牌飞向屏幕中央的动画
                const targetX = this.canvasWidth / 2 - card.width / 2;
                const targetY = this.canvasHeight / 2 - card.height / 2;
                
                // 存储目标位置
                card.targetPosition = { x: targetX, y: targetY };
                
                // 设置动画时间
                const animationDuration = 500; // 毫秒
                const startTime = Date.now();
                const startX = card.x;
                const startY = card.y;
                const startScale = card.currentScale;
                const targetScale = 2.5; // 放大2.5倍
                
                // 设置卡牌旋转随机角度 (-5到5度)
                const targetAngle = Math.random() * 10 - 5;
                const startAngle = card.angle;
                
                // 动画函数
                const animate = () => {
                    const currentTime = Date.now();
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / animationDuration, 1);
                    
                    // 使用缓动函数使动画更自然
                    const easeProgress = this.easeOutQuad(progress);
                    
                    // 更新卡牌位置
                    card.x = startX + (targetX - startX) * easeProgress;
                    card.y = startY + (targetY - startY) * easeProgress;
                    card.currentScale = startScale + (targetScale - startScale) * easeProgress;
                    card.angle = startAngle + (targetAngle - startAngle) * easeProgress;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        // 动画完成，显示卡牌信息
                        this.showCardInfo(card);
                        card.animating = false;
                        this.isAnimating = false;
                    }
                };
                
                requestAnimationFrame(animate);
            }
            
            // 显示卡牌信息面板
            showCardInfo(card) {
                // 设置卡牌信息
                cardImage.src = 'quin1.jpg'; // 用一个默认图片
                cardName.textContent = card.name;
                cardDescription.textContent = card.description;
                
                // 找到一个可用的卡牌槽
                let availableSlot = null;
                for (const slot of cardSlots) {
                    if (!slot.hasAttribute('data-filled')) {
                        availableSlot = slot;
                        break;
                    }
                }
                
                if (availableSlot) {
                    this.currentSlot = availableSlot;
                    
                    // 高亮显示槽位
                    cardSlots.forEach(slot => slot.classList.remove('highlight'));
                    this.currentSlot.classList.add('highlight');
                    
                    // 显示面板和遮罩
                    cardInfoPanel.style.display = 'block';
                    overlay.style.display = 'block';
                } else {
                    // 所有槽位已满，重置卡牌位置
                    this.resetCardPosition(card);
                }
            }
            
            // 将卡牌放入槽位
            placeCardInSlot(card, slot) {
                // 标记槽位已填充
                slot.setAttribute('data-filled', 'true');
                slot.classList.add('filled');
                
                // 记录卡牌位置和关联槽位
                card.position = slot.getAttribute('data-position');
                card.placed = true;
                card.slotElement = slot;
                this.selectedCards.push(card);
                
                // 计算槽位中心位置 (世界坐标)
                const slotRect = slot.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                
                const targetX = (slotRect.left + slotRect.width / 2) - canvasRect.left - card.width / 2;
                const targetY = (slotRect.top + slotRect.height / 2) - canvasRect.top - card.height / 2;
                
                // 设置动画参数
                const animationDuration = 600; // 毫秒
                const startTime = Date.now();
                const startX = card.x;
                const startY = card.y;
                const startScale = card.currentScale;
                const targetScale = 1.8; // 卡牌在槽中的大小
                const startAngle = card.angle;
                const targetAngle = 0; // 卡牌在槽中为正向
                
                // 设置动画状态
                this.isAnimating = true;
                card.animating = true;
                
                // 动画函数
                const animate = () => {
                    const currentTime = Date.now();
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / animationDuration, 1);
                    
                    // 使用缓动函数
                    const easeProgress = this.easeOutQuad(progress);
                    
                    // 更新卡牌位置
                    card.x = startX + (targetX - startX) * easeProgress;
                    card.y = startY + (targetY - startY) * easeProgress;
                    card.currentScale = startScale + (targetScale - startScale) * easeProgress;
                    card.angle = startAngle + (targetAngle - startAngle) * easeProgress;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        // 动画完成
                        card.animating = false;
                        this.isAnimating = false;
                        
                        // 更新选中卡牌计数
                        cardsCounter.textContent = `已选择: ${this.selectedCards.length}/3`;
                        
                        // 如果已选择3张卡牌，显示查看结果按钮
                        if (this.selectedCards.length === 3) {
                            drawInstruction.textContent = "已抽取所有塔罗牌";
                            viewResultBtn.classList.remove('hidden');
                            
                            // 更新查看结果按钮的链接
                            const resultBtn = viewResultBtn.querySelector('a');
                            if (resultBtn && master && question) {
                                resultBtn.href = `result.html?master=${master}&question=${encodeURIComponent(question)}&spread=${spread || 'time-flow'}`;
                            }
                        } else {
                            drawInstruction.textContent = `已抽取 ${this.selectedCards.length}/3 张牌，请继续选择`;
                        }
                        
                        // 取消槽位高亮
                        this.currentSlot.classList.remove('highlight');
                    }
                };
                
                requestAnimationFrame(animate);
            }
            
            // 重置卡牌位置
            resetCardPosition(card) {
                // 如果所有槽位已满，将卡牌动画回原位
                const originalX = card.x;
                const originalY = card.y;
                const originalScale = card.currentScale;
                const originalAngle = card.angle;
                
                const animationDuration = 500; // 毫秒
                const startTime = Date.now();
                
                // 设置动画状态
                this.isAnimating = true;
                card.animating = true;
                
                // 动画函数
                const animate = () => {
                    const currentTime = Date.now();
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / animationDuration, 1);
                    
                    // 使用缓动函数
                    const easeProgress = this.easeOutQuad(progress);
                    
                    // 更新卡牌位置
                    card.x = originalX;
                    card.y = originalY;
                    card.currentScale = originalScale;
                    card.angle = originalAngle;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        // 动画完成
                        card.animating = false;
                        this.isAnimating = false;
                    }
                };
                
                requestAnimationFrame(animate);
            }
            
            // 缓动函数
            easeOutQuad(t) {
                return t * (2-t);
            }
            
            // 绘制函数
            draw() {
                // 清空画布
                ctx.clearRect(0, 0, this.canvasWidth, this.canvasHeight);
                
                // 绘制一些装饰星星
                this.drawStars();
                
                // 先绘制牌列中的牌
                this.cards.forEach(card => {
                    if (!card.placed) {
                        card.draw(ctx);
                    }
                });
                
                // 根据卡牌对应的position顺序排序
                const positionOrder = {"过去": 0, "现在": 1, "未来": 2};
                const sortedPlacedCards = [...this.selectedCards].sort((a, b) => {
                    return positionOrder[a.position] - positionOrder[b.position];
                });
                
                // 再绘制已放置的卡牌，确保它们显示在槽位上方
                sortedPlacedCards.forEach(card => {
                    card.draw(ctx);
                });
                
                // 绘制指示线
                if (this.selectedCards.length > 0) {
                    // 如果有放置的卡牌，绘制卡牌与槽位之间的连接线
                    this.drawCardConnectionLines();
                }
            }
            
            // 绘制卡牌与槽位之间的连接线
            drawCardConnectionLines() {
                this.selectedCards.forEach(card => {
                    if (card.slotElement) {
                        // 绘制从卡牌中心到槽位中心的线
                        const slotRect = card.slotElement.getBoundingClientRect();
                        const canvasRect = canvas.getBoundingClientRect();
                        
                        // 计算槽位中心在canvas坐标系中的位置
                        const slotCenterX = (slotRect.left + slotRect.width / 2) - canvasRect.left;
                        const slotCenterY = (slotRect.top + slotRect.height / 2) - canvasRect.top;
                        
                        // 计算卡牌中心
                        const cardCenterX = card.x + card.width / 2;
                        const cardCenterY = card.y + card.height / 2;
                        
                        // 绘制连接线
                        ctx.save();
                        ctx.strokeStyle = 'rgba(215, 170, 100, 0.2)';
                        ctx.lineWidth = 1;
                        ctx.setLineDash([5, 3]);
                        ctx.beginPath();
                        ctx.moveTo(cardCenterX, cardCenterY);
                        ctx.lineTo(slotCenterX, slotCenterY);
                        ctx.stroke();
                        ctx.restore();
                    }
                });
            }
            
            // 绘制背景星星
            drawStars() {
                const time = Date.now() / 1000;
                const numStars = 50;
                
                for (let i = 0; i < numStars; i++) {
                    const x = (Math.sin(i * 0.3 + time * 0.1) * 0.5 + 0.5) * this.canvasWidth;
                    const y = (Math.cos(i * 0.5 + time * 0.1) * 0.5 + 0.5) * this.canvasHeight * 0.7;
                    const size = (Math.sin(i + time) * 0.5 + 0.5) * 2 + 0.5;
                    const alpha = (Math.sin(i * 0.2 + time * 0.5) * 0.5 + 0.5) * 0.3 + 0.1;
                    
                    ctx.fillStyle = `rgba(215, 170, 100, ${alpha})`;
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // 动画循环
            animate() {
                this.draw();
                requestAnimationFrame(() => this.animate());
            }
        }
        
        // 添加圆角矩形方法
        CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            this.beginPath();
            this.moveTo(x + r, y);
            this.arcTo(x + w, y, x + w, y + h, r);
            this.arcTo(x + w, y + h, x, y + h, r);
            this.arcTo(x, y + h, x, y, r);
            this.arcTo(x, y, x + w, y, r);
            this.closePath();
            return this;
        };
        
        // 初始化应用
        let app;
        
        // 确保DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            app = new TarotApp();
        });
        
        // 如果已加载完成则立即初始化
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(() => { app = new TarotApp(); }, 1);
        }
    </script>
</body>
</html> 